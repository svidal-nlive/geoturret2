var T=class{state;constructor(t){if(typeof t=="string"){let r=5381;for(let a=0;a<t.length;a++)r=(r<<5)+r^t.charCodeAt(a);this.state=r>>>0}else this.state=t>>>0;this.state===0&&(this.state=1)}next(){return this.state=1664525*this.state+1013904223>>>0,this.state/4294967296}int(t,r){if(r<t)throw new Error("RNG.int: max < min");let a=r-t+1;return t+Math.floor(this.next()*a)}choice(t){if(!t.length)throw new Error("RNG.choice: empty array");return t[this.int(0,t.length-1)]}snapshot(){return this.state}restore(t){this.state=t>>>0||1}},q=new T("geoturret2-seed");var B=class{listeners=new Map;on(t,r){let a=this.listeners.get(t);return a||(a=new Set,this.listeners.set(t,a)),a.add(r),()=>this.off(t,r)}off(t,r){let a=this.listeners.get(t);a&&(a.delete(r),a.size||this.listeners.delete(t))}emit(t,r){let a=this.listeners.get(t);a&&[...a].forEach(n=>{try{n(r)}catch{}})}clear(){this.listeners.clear()}},y=new B;var I=new Map,A=new Map,U=new Map,K=new Map,H=new Map;function L(e,t,r){if(e.has(t.id))throw new Error(`${r} already registered: ${t.id}`);e.set(t.id,t)}var c={enemy:e=>L(I,e,"enemy"),powerup:e=>L(A,e,"powerup"),upgrade:e=>L(U,e,"upgrade"),waveMod:e=>L(K,e,"waveMod"),bossPattern:e=>L(H,e,"bossPattern"),snapshot:()=>({enemies:[...I.keys()],powerups:[...A.keys()],upgrades:[...U.keys()],waveMods:[...K.keys()],bossPatterns:[...H.keys()]}),hash(){let e=a=>[...a.keys()].sort().join("|"),t=[e(I),e(A),e(U),e(K),e(H)].join("#"),r=5381;for(let a=0;a<t.length;a++)r=(r<<5)+r^t.charCodeAt(a);return(r>>>0).toString(16).padStart(8,"0")}};function F(e){let t=e.rng.snapshot?e.rng.snapshot():0,r=e.state?.kills??0,a=e.state?.wave??0,n=e.state?.parallaxLayers;return{version:3,frame:e.frame,time:e.time,rngState:t,registries:c.snapshot(),registryHash:c.hash(),summary:{kills:r,wave:a,parallaxLayers:n}}}var G=class{systems=[];frame=0;time=0;accumulator=0;step;rng;profilerEnabled=!1;lastProfile;summarySource;constructor(t){if(this.step=t?.fixedStep??1/60,t?.seed instanceof T)this.rng=t.seed;else if(typeof t?.seed<"u")this.rng=new T(t.seed);else throw new Error("Orchestrator requires explicit seed (number|string|RNG) for determinism.");this.summarySource=t?.summarySource}register(t){if(this.systems.find(r=>r.id===t.id))throw new Error(`System id already registered: ${t.id}`);this.systems.push(t),this.sortSystems()}sortSystems(){this.systems.sort((t,r)=>(t.order??0)-(r.order??0))}init(){let t=this.buildContext();for(let r of this.systems)r.init?.(t)}advance(t){this.accumulator+=t;let r=0;for(;this.accumulator+1e-12>=this.step;)this.accumulator-=this.step,this.tick(),r++;return r}tick(){let t=this.buildContext();if(this.profilerEnabled){this.lastProfile={};for(let r of this.systems){let a=performance.now();r.update(this.step,t),this.lastProfile[r.id]=performance.now()-a}y.emit("perfSample",{frame:this.frame,profiling:this.lastProfile})}else for(let r of this.systems)r.update(this.step,t);this.frame++,this.time+=this.step,y.emit("frame",{frame:this.frame,time:this.time})}buildContext(){return{frame:this.frame,time:this.time,rng:this.rng,emit:y.emit.bind(y),on:y.on.bind(y)}}teardown(){let t=this.buildContext();for(let r of[...this.systems].reverse())r.teardown?.(t)}getMetrics(){return{frame:this.frame,time:this.time,systems:this.systems.length,stepsLastAdvance:0,accumulator:this.accumulator,profiling:this.lastProfile}}getStep(){return this.step}enableProfiler(t=!0){this.profilerEnabled=t}snapshot(){let t=F({frame:this.frame,time:this.time,rng:this.rng,state:this.summarySource?.()});return y.emit("snapshot",{frame:t.frame,time:t.time,registryHash:t.registryHash,summary:t.summary}),t}};var X=class{constructor(t=50){this.capacity=t}buf=[];push(t){let r=t instanceof Error?t:new Error(String(t));this.buf.push({time:Date.now(),message:r.message,stack:r.stack}),this.buf.length>this.capacity&&this.buf.shift()}list(){return[...this.buf]}clear(){this.buf=[]}},we=new X;function J(){if(Math._gt2ShimInstalled)return;let e=Math.random;Math._originalRandom=e,Math.random=()=>q.next(),Math._gt2ShimInstalled=!0}var O=class{constructor(t){this.opts=t;this.max=t.max;for(let r=0;r<t.initial;r++)this.free.push(this.make())}free=[];total=0;created=0;max;make(){return this.total++,this.created++,this.opts.create()}acquire(){if(this.free.length)return this.free.pop();if(!(this.max!==void 0&&this.total>=this.max))return this.make()}release(t){this.opts.reset?.(t),this.free.push(t)}stats(){return{size:this.total,free:this.free.length,inUse:this.total-this.free.length,created:this.created,max:this.max}}preallocate(t){for(let r=0;r<t&&!(this.max!==void 0&&this.total>=this.max);r++)this.free.push(this.make())}};c.enemy({id:"grunt",hp:10,speed:1});c.enemy({id:"swift",hp:6,speed:1.6});c.enemy({id:"tank",hp:30,speed:.6});c.powerup({id:"shield",duration:5});c.powerup({id:"overdrive",duration:8});c.upgrade({id:"damage+",tier:1});c.upgrade({id:"firerate+",tier:1});c.upgrade({id:"spread+",tier:1});c.waveMod({id:"storm",description:"Increased projectile density"});c.waveMod({id:"gravity",description:"Projectiles arc downward"});c.bossPattern({id:"laser-cross",version:1});c.bossPattern({id:"safe-lane-volley",version:1});c.bossPattern({id:"multi-beam-intersect",version:1});function W(){let e=new O({initial:32,create:()=>({id:0,x:0,y:0,vx:0,vy:0,hp:0,alive:!1}),reset:r=>{r.alive=!1}}),t=new O({initial:64,create:()=>({id:0,x:0,y:0,vx:0,vy:0,alive:!1}),reset:r=>{r.alive=!1}});return{enemies:[],bullets:[],enemyPool:e,bulletPool:t,kills:0,wave:0,waveKills:0,waveTarget:10,enemySpawnTimer:0,bulletTimer:0,nextEnemyId:1,nextBulletId:1,camera:{x:0,y:0,zoom:1,targetZoom:1,shakeRemaining:0,shakeDuration:0,shakeAmp:0,shakeFreq:25,shakeX:0,shakeY:0},parallax:{layers:[]}}}var l={x:0,y:0};function j(e){return{id:"player",order:-100,init:()=>{l.x=0,l.y=0},update:(t,r)=>{}}}function Z(e=120){let t={};function r(n){t[n.key.toLowerCase()]=!0}function a(n){t[n.key.toLowerCase()]=!1}return{id:"input",order:-200,init:()=>{window.addEventListener("keydown",r),window.addEventListener("keyup",a)},update:(n,o)=>{let s=0,m=0;if((t.w||t.arrowup)&&(m-=1),(t.s||t.arrowdown)&&(m+=1),(t.a||t.arrowleft)&&(s-=1),(t.d||t.arrowright)&&(s+=1),s||m){let i=Math.hypot(s,m)||1;s/=i,m/=i,l.x+=s*e*n,l.y+=m*e*n}},teardown:()=>{window.removeEventListener("keydown",r),window.removeEventListener("keyup",a)}}}function Q(e){return{id:"enemySpawn",order:-50,update:(t,r)=>{e.enemySpawnTimer+=t;let a=.75;for(;e.enemySpawnTimer>=a;){e.enemySpawnTimer-=a;let n=e.enemyPool.acquire();if(!n)break;let o=r.rng.next()*Math.PI*2,s=120+r.rng.next()*60,m=20+r.rng.next()*20;n.id=e.nextEnemyId++,n.x=Math.cos(o)*s,n.y=Math.sin(o)*s,n.vx=-Math.cos(o)*m,n.vy=-Math.sin(o)*m,n.hp=1,n.alive=!0,e.enemies.push(n)}for(let n of e.enemies)n.alive&&(n.x+=n.vx*t,n.y+=n.vy*t)}}}function V(e){return{id:"bullets",order:0,update:(t,r)=>{e.bulletTimer+=t;let a=.2;for(;e.bulletTimer>=a;){e.bulletTimer-=a;let n=e.bulletPool.acquire();if(!n)break;let s=e.nextBulletId%60*(Math.PI*2/60),m=140;n.id=e.nextBulletId++,n.x=l.x,n.y=l.y,n.vx=Math.cos(s)*m,n.vy=Math.sin(s)*m,n.alive=!0,e.bullets.push(n)}for(let n of e.bullets)n.alive&&(n.x+=n.vx*t,n.y+=n.vy*t)}}}function ee(e){return{id:"collision",order:10,update:(t,r)=>{for(let a of e.bullets)if(a.alive){for(let n of e.enemies)if(n.alive){let o=n.x-a.x,s=n.y-a.y;if(o*o+s*s<144){n.alive=!1,a.alive=!1,e.kills++,e.waveKills++;break}}}if(e.kills%5===0){for(let a=e.enemies.length-1;a>=0;a--){let n=e.enemies[a];n.alive||(e.enemies.splice(a,1),e.enemyPool.release(n))}for(let a=e.bullets.length-1;a>=0;a--){let n=e.bullets[a];(!n.alive||Math.abs(n.x)>400||Math.abs(n.y)>400)&&(e.bullets.splice(a,1),e.bulletPool.release(n))}}}}}function te(e){let t=null,r=null;function a(){t=document.getElementById("game"),t&&(r=t.getContext("2d"))}function n(){!t||!r||(r.fillStyle="#000",r.fillRect(0,0,t.width,t.height))}function o(){if(!t||!r)return;r.save();let m=t.width/(2*devicePixelRatio),i=t.height/(2*devicePixelRatio);r.translate(m,i);let u=e.camera.zoom||1;r.scale(u,u),r.translate(-e.camera.x+(e.camera.shakeX||0)/u,-e.camera.y+(e.camera.shakeY||0)/u)}function s(){r&&r.restore()}return{id:"render",order:100,init:()=>{typeof window<"u"&&a()},update:()=>{if(!t||!r)return;n(),o();let m=e.parallax?.layers?.length?e.parallax.layers:[{depth:.2,offsetX:e.camera.x*.2,offsetY:e.camera.y*.2},{depth:.5,offsetX:e.camera.x*.5,offsetY:e.camera.y*.5}];for(let i of m){let u=i.offsetX,P=i.offsetY,d=i.color||(i.depth<.3?"#113":"#225");r.fillStyle=d;let k=i.tileSize||(i.depth<.3?1800:1200),h=i.step||(i.depth<.3?140:90),C=Math.floor((u-k/2)/h)*h,E=Math.floor((P-k/2)/h)*h;for(let w=C;w<u+k/2;w+=h)for(let R=E;R<P+k/2;R+=h){let x=w-u,v=R-P;r.fillRect(x,v,2,2)}}r.strokeStyle="#0af",r.beginPath(),r.arc(l.x,l.y,10,0,Math.PI*2),r.stroke(),r.fillStyle="#ff0";for(let i of e.bullets)i.alive&&r.fillRect(i.x-2,i.y-2,4,4);r.fillStyle="#f44";for(let i of e.enemies)i.alive&&(r.beginPath(),r.arc(i.x,i.y,8,0,Math.PI*2),r.fill());s()}}}function re(e,t){let r=t?.stiffness??10,a=t?.deadzone??8,n=t?.zoomStiffness??6,o=t?.leadTime??0,s=t?.maxLead??160,m=t?.worldRadius??0,i=t?.bounds;typeof window<"u"&&(window.cameraShake=function(d=.4,k=24,h=28){e.camera.shakeDuration=d,e.camera.shakeRemaining=d,e.camera.shakeAmp=k,e.camera.shakeFreq=h},window.cameraZoomTo=function(d=1){e.camera.targetZoom=Math.max(.2,Math.min(3,d))});let u=l.x,P=l.y;return{id:"camera",order:-150,update:(d,k)=>{let h=e.camera.x,C=e.camera.y,E=l.x,w=l.y;if(o>0&&d>0){let g=(l.x-u)/d,M=(l.y-P)/d,b=g*o,S=M*o,_=Math.hypot(b,S);if(_>s){let N=s/(_||1);b*=N,S*=N}E+=b,w+=S}Math.abs(E-h)<a&&(E=h),Math.abs(w-C)<a&&(w=C);let R=1-Math.exp(-r*d),x=h+(E-h)*R,v=C+(w-C)*R;if(i)x=Math.max(i.minX,Math.min(i.maxX,x)),v=Math.max(i.minY,Math.min(i.maxY,v));else if(m>0){let g=x*x+v*v,M=m;if(g>M*M){let b=Math.sqrt(g);x=x/b*M,v=v/b*M}}e.camera.x=x,e.camera.y=v;let me=1-Math.exp(-n*d);if(e.camera.zoom+=(e.camera.targetZoom-e.camera.zoom)*me,e.camera.shakeRemaining>0){e.camera.shakeRemaining-=d;let g=e.camera.shakeDuration-e.camera.shakeRemaining,b=Math.max(0,e.camera.shakeRemaining)/e.camera.shakeDuration,S=e.camera.shakeFreq;e.camera.shakeX=(Math.sin(g*S*13.37)*.5+Math.sin(g*S*7.11)*.5)*e.camera.shakeAmp*b,e.camera.shakeY=(Math.cos(g*S*11.17)*.5+Math.sin(g*S*5.27)*.5)*e.camera.shakeAmp*b}else e.camera.shakeX=0,e.camera.shakeY=0;u=l.x,P=l.y}}}function ae(e){return{id:"wave",order:-90,update:(t,r)=>{if(e.waveKills>=e.waveTarget){let a=e.wave;e.wave+=1,e.waveKills=0,e.waveTarget=Math.min(100,Math.ceil(e.waveTarget*1.25)),y.emit("waveStart",{wave:e.wave,prevWave:a,target:e.waveTarget})}}}}function ne(e,t){let r=t?.length?t:[{depth:.2,density:.5,color:"#113",tileSize:1800,step:140},{depth:.5,density:.8,color:"#225",tileSize:1200,step:90}];if(typeof window<"u"){let a=s=>s&&typeof s.depth=="number"&&isFinite(s.depth)&&s.depth>0&&s.depth<=2,n=s=>({depth:Math.max(.01,Math.min(2,+s.depth)),density:typeof s.density=="number"?Math.max(0,Math.min(5,s.density)):void 0,color:typeof s.color=="string"?s.color:void 0,tileSize:typeof s.tileSize=="number"&&s.tileSize>0?Math.min(8192,s.tileSize):void 0,step:typeof s.step=="number"&&s.step>0?Math.min(1024,s.step):void 0}),o=()=>{try{let s=encodeURIComponent(JSON.stringify(r));if(typeof history<"u"){let m=new URL(window.location.href);m.searchParams.set("parallaxJ",s),history.replaceState(null,"",m.toString())}window.localStorage.setItem("parallaxLayers",JSON.stringify(r))}catch{}};window.parallaxSetLayers=s=>{Array.isArray(s)&&s.every(a)&&(r=s.map(n),o())},window.parallaxAddLayer=s=>a(s)?(r.push(n(s)),o(),!0):!1,window.parallaxRemoveLayer=s=>typeof s=="number"&&s>=0&&s<r.length?(r.splice(s,1),o(),!0):!1,window.parallaxUpdateLayer=(s,m)=>{if(s<0||s>=r.length)return!1;let i={...r[s],...m};return a(i)?(r[s]=n(i),o(),!0):!1},window.parallaxListLayers=()=>r.map(s=>({...s})),window.parallaxSerializeLayers=()=>encodeURIComponent(JSON.stringify(r)),window.parallaxPersist=o;try{let m=new URL(window.location.href).searchParams.get("parallaxJ");if(m){let i=JSON.parse(decodeURIComponent(m));Array.isArray(i)&&i.every(a)&&(r=i.map(n))}else{let i=window.localStorage.getItem("parallaxLayers");if(i){let u=JSON.parse(i);Array.isArray(u)&&u.every(a)&&(r=u.map(n))}}}catch(s){console.warn("[parallax] failed to parse parallaxJ param",s)}}return e.parallax||(e.parallax={layers:[]}),{id:"parallax",order:80,update:(a,n)=>{e.parallax.layers=r.map(o=>({depth:o.depth,offsetX:e.camera.x*o.depth,offsetY:e.camera.y*o.depth,color:o.color,tileSize:o.tileSize,step:o.step}))}}}J();var ie=new URL(window.location.href),$=ie.searchParams.get("seed")||"dev-seed",le=ie.searchParams.get("autopause")==="1",f=W(),p=new G({seed:$,fixedStep:1/60,summarySource:()=>({kills:f.kills,wave:f.wave,parallaxLayers:f.parallax?.layers?.map(e=>{let t=e;return{depth:t.depth,color:t.color,tileSize:t.tileSize,step:t.step}})||[]})});p.register(Z());p.register(re(f));p.register(j(f));p.register(ae(f));p.register(Q(f));p.register(V(f));p.register(ee(f));p.register(te(f));p.register(ne(f));var ce=document.getElementById("overlay"),z=!1,D=!1,Y=!1;window.addEventListener("keydown",e=>{e.key==="p"&&(z=!z,p.enableProfiler(z)),e.key==="s"&&console.log("Snapshot",p.snapshot()),e.key===" "&&(D=!D),e.key==="."&&(Y=!0)});p.init();var se=performance.now();function oe(e){let t=(e-se)/1e3;se=e,D?Y&&(p.advance(p.getStep()),Y=!1):p.advance(t);let r=p.getMetrics();ce.textContent=`seed:${$}
frame:${r.frame}
time:${r.time.toFixed(2)}s
(kills:${f.kills} wave:${f.wave})${D?" [PAUSED]":""}
E pool: inUse=${f.enemyPool.stats().inUse} free=${f.enemyPool.stats().free}
B pool: inUse=${f.bulletPool.stats().inUse} free=${f.bulletPool.stats().free}`+(z&&r.profiling?`
`+Object.entries(r.profiling).map(([a,n])=>`${a}:${n.toFixed(3)}ms`).join(`
`):""),requestAnimationFrame(oe)}requestAnimationFrame(oe);console.log("[Geoturret2] Dev harness started with seed",$,le?"(paused)":"");
//# sourceMappingURL=size-check.js.map
