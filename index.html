<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Geoturret 2 – Dev Harness</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      body { margin:0; font:12px system-ui, sans-serif; background:#111; color:#eee; }
      /* Skip link appears on keyboard focus */
      .skip-link { position:absolute; left:8px; top:-48px; background:#fff; color:#000; padding:8px 12px; border-radius:4px; font-weight:600; text-decoration:none; z-index:1000; box-shadow:0 2px 6px rgba(0,0,0,.4); transition:top .15s ease; }
      .skip-link:focus, .skip-link:focus-visible { top:8px; outline:2px solid #fff; outline-offset:2px; }
      /* Global focus ring for interactive elements */
      :focus-visible { outline:2px solid #0af; outline-offset:2px; }
      @media (prefers-contrast: more) { :focus-visible { outline-color:#fff; } }
      /* Assistive utility: hide visually while keeping accessible to screen readers */
      .visually-hidden { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0 0 0 0); border:0; }
  #overlay { position:fixed; top:4px; left:6px; background:rgba(0,0,0,.5); padding:6px 8px; border-radius:4px; line-height:1.3; font-family:monospace; }
  #hud { position:fixed; top:4px; right:6px; display:flex; flex-direction:column; gap:6px; font-family:system-ui, sans-serif; pointer-events:none; }
  .hud-panel { background:rgba(0,0,0,.55); padding:6px 8px; border:1px solid rgba(255,255,255,.15); border-radius:4px; min-width:160px; backdrop-filter:blur(4px); box-shadow:0 2px 4px rgba(0,0,0,.4); }
  /* Phase 2 HUD additions */
  #hud-top { position:fixed; top:4px; left:50%; transform:translateX(-50%); display:flex; flex-direction:column; gap:4px; font:12px system-ui,sans-serif; pointer-events:none; max-width:70vw; }
  .hud-top-line { display:flex; gap:24px; justify-content:center; flex-wrap:wrap; background:rgba(0,0,0,.55); padding:4px 10px; border-radius:6px; border:1px solid rgba(255,255,255,.15); backdrop-filter:blur(4px); }
  #hud-boss-phase { font-weight:600; letter-spacing:.5px; text-transform:uppercase; color:#ffd84d; text-shadow:0 0 3px rgba(255,190,60,.5); }
  #hud-boss-phase-progress { position:relative; width:140px; height:8px; background:rgba(255,255,255,.12); border-radius:5px; overflow:hidden; border:1px solid rgba(255,255,255,.18); display:none; }
  #hud-boss-phase-progress .seg { position:absolute; top:0; bottom:0; width:0%; transition:width .15s linear; }
  #hud-boss-phase-progress .seg.telegraph { left:0; background:linear-gradient(90deg,#ffe08a,#ffba2d); box-shadow:0 0 4px rgba(255,200,80,.55); }
  #hud-boss-phase-progress .seg.fire { background:linear-gradient(90deg,#ff6a3a,#ff2d2d); box-shadow:0 0 5px rgba(255,80,40,.6); }
  /* Fire segment sits after telegraph portion; we position it dynamically via transform translateX */
  #hud-coins { font-weight:600; }
  #hud-coin-delta { color:#6ef; margin-left:4px; opacity:0; transform:translateY(0) scale(0.85); font-weight:600; text-shadow:0 0 4px rgba(0,170,255,.6); transition:opacity .25s ease, transform .35s cubic-bezier(.22,1.2,.32,1); position:relative; }
  #hud-coin-delta.visible { opacity:1; transform:translateY(-2px) scale(1); }
  #hud-coin-delta.bump { animation:coinBump .55s cubic-bezier(.22,1.4,.32,1); }
  /* Distinguish gain vs spend for color semantics (inline HSL still applied for dynamic intensity) */
  #hud-coin-delta.gain { text-shadow:0 0 4px rgba(0,170,255,.6); }
  #hud-coin-delta.spend { text-shadow:0 0 4px rgba(255,60,30,.6); }
  @keyframes coinBump { 0% { transform:translateY(-2px) scale(1); } 25% { transform:translateY(-7px) scale(1.25); filter:brightness(1.4); } 55% { transform:translateY(-4px) scale(1.05); } 100% { transform:translateY(-2px) scale(1); } }
  /* Burst particles for coin gain */
  .coin-burst { position:absolute; pointer-events:none; font-size:10px; line-height:10px; animation:coinPart .8s ease forwards; opacity:0; }
  @keyframes coinPart { 0% { opacity:0; transform:translate(0,0) scale(.4); } 10% { opacity:1; } 70% { opacity:1; } 100% { opacity:0; transform:translate(var(--dx), var(--dy)) scale(1); } }
  .hud-overdrive-line { display:flex; align-items:center; gap:8px; background:rgba(0,0,0,.55); padding:4px 10px; border-radius:6px; border:1px solid rgba(255,255,255,.15); backdrop-filter:blur(4px); }
  .hud-meter.overdrive { flex:1; height:8px; background:rgba(255,255,255,.12); border-radius:4px; position:relative; overflow:hidden; }
  .hud-meter.overdrive > div { position:absolute; top:0; left:0; bottom:0; width:0%; background:linear-gradient(90deg,#0af,#6ef); box-shadow:0 0 4px rgba(0,170,255,.6); transition:width .15s linear, background .25s ease; }
  .overdrive-active .hud-meter.overdrive > div { background:linear-gradient(90deg,#ffd84d,#ff9c1a); box-shadow:0 0 6px 2px rgba(255,170,0,.6); }
  /* Reduced motion global class (added to body) trims transitions */
  body.motion-reduction * { animation-duration:0s !important; transition-duration:0s !important; }
  #hud-bottom { position:fixed; bottom:8px; left:50%; transform:translateX(-50%); display:flex; flex-direction:column; gap:4px; pointer-events:none; }
  .hud-bar { position:relative; width:360px; max-width:80vw; height:12px; background:rgba(255,255,255,.12); border-radius:6px; overflow:hidden; border:1px solid rgba(255,255,255,.15); backdrop-filter:blur(4px); }
  .hud-bar > div { position:absolute; top:0; left:0; bottom:0; width:0%; background:#0af; transition:width .2s ease; }
  .hud-bar.armor > div { background:#fa0; }
  /* Health / Armor dynamic states */
  .hud-bar.health.low > div { background:#f9a825; }
  .hud-bar.health.critical > div { background:#ff4020; animation:healthPulse var(--hpPulseDur,1s) ease-in-out infinite; }
  .hud-bar.health.dead > div { background:#555; }
  .hud-bar.armor.low > div { background:#ffbb55; }
  @keyframes healthPulse { 0% { filter:brightness(1); } 50% { filter:brightness(1.5); } 100% { filter:brightness(1); } }
  /* Damage flash */
  .hud-bar.damage-flash { animation:damageFlash .5s ease; }
  @keyframes damageFlash { 0% { box-shadow:0 0 0 0 rgba(255,80,80,.9), inset 0 0 6px rgba(255,0,0,.6); } 40% { box-shadow:0 0 12px 4px rgba(255,80,80,.7), inset 0 0 10px rgba(255,0,0,.8); } 100% { box-shadow:0 0 0 0 rgba(255,80,80,0), inset 0 0 0 rgba(255,0,0,0); } }
  .hud-bar.armor.damage-flash { animation:armorFlash .5s ease; }
  @keyframes armorFlash { 0% { box-shadow:0 0 0 0 rgba(255,200,80,.9), inset 0 0 6px rgba(255,160,0,.6); } 40% { box-shadow:0 0 12px 4px rgba(255,200,80,.7), inset 0 0 10px rgba(255,160,0,.8); } 100% { box-shadow:0 0 0 0 rgba(255,160,0,0), inset 0 0 0 rgba(255,160,0,0); } }
  .hud-bar-label { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font:600 11px system-ui,sans-serif; color:#fff; text-shadow:0 0 3px rgba(0,0,0,.7); pointer-events:none; }
  #hud-top.hud-hidden, #hud-bottom.hud-hidden { display:none; }
  /* Provide always-visible ring when focused by keyboard or programmatic click */
  #game:focus-visible { outline:3px solid #0af; outline-offset:-3px; }
  /* HUD toggle button (mobile / no-keyboard users) */
  #hud-toggle-btn { position:fixed; bottom:12px; right:12px; z-index:1100; background:rgba(0,0,0,.55); color:#fff; border:1px solid rgba(255,255,255,.25); padding:10px 14px; font:600 12px system-ui,sans-serif; border-radius:8px; cursor:pointer; backdrop-filter:blur(4px); display:flex; align-items:center; gap:6px; }
  #hud-toggle-btn:focus-visible { outline:2px solid #0af; }
  #hud-toggle-btn[aria-pressed="true"] { background:rgba(10,160,255,.65); }
  #hud-toggle-btn .hud-icon { width:14px; height:14px; display:inline-block; background:currentColor; mask:radial-gradient(circle at 50% 50%,#000 55%,transparent 56%); -webkit-mask:radial-gradient(circle at 50% 50%,#000 55%,transparent 56%); }
  #settings-btn { position:fixed; bottom:12px; left:12px; z-index:1100; background:rgba(0,0,0,.55); color:#fff; border:1px solid rgba(255,255,255,.25); padding:10px 14px; font:600 12px system-ui,sans-serif; border-radius:8px; cursor:pointer; backdrop-filter:blur(4px); }
  /* Game over overlay */
  #game-over { position:fixed; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; background:rgba(0,0,0,.85); color:#fff; font:16px system-ui,sans-serif; gap:18px; z-index:1500; opacity:0; pointer-events:none; transition:opacity .35s ease; }
  #game-over.visible { opacity:1; pointer-events:auto; }
  #game-over h2 { margin:0; font-size:42px; letter-spacing:1px; background:linear-gradient(90deg,#ff4d4d,#ffa64d); -webkit-background-clip:text; background-clip:text; color:transparent; }
  #game-over .stats { font:13px monospace; text-align:center; line-height:1.4; }
  #game-over button { background:#0af; color:#000; border:none; padding:10px 20px; font:600 14px system-ui,sans-serif; border-radius:8px; cursor:pointer; }
  #game-over button:focus-visible { outline:2px solid #fff; }
  @media (prefers-reduced-motion: reduce) { #hud-toggle-btn { transition:none; } }
    </style>
  </head>
  <body>
    <a href="#main" class="skip-link">Skip to game content</a>
    <main id="main" tabindex="-1">
      <h1 class="visually-hidden">Geoturret 2</h1>
  <!-- Canvas: remove role=application (prefer default semantics); provide descriptive title instead of aria-label to avoid prohibited attr warnings -->
  <canvas id="game" tabindex="0" title="Game playfield"></canvas>
      <div id="overlay" role="status" aria-live="polite">loading...</div>
  <div id="hud-top">
        <div class="hud-top-line">
          <span id="hud-coins">Coins <span data-k="coins">0</span><span id="hud-coin-delta" aria-live="polite"></span></span>
          <span id="hud-wave">Wave <span data-k="wave">0</span></span>
          <span id="hud-seed">Seed <span data-k="seed">–</span></span>
           <div id="hud-boss-phase" aria-live="polite" aria-atomic="true" hidden></div>
           <span id="hud-fairness-adj">Fairness x<span data-k="fairAdj">1.00</span></span>
           <span id="hud-boss-phase-timer" hidden>0.0s</span>
           <span id="hud-boss-phase-eta" hidden>ETA 0.0s</span>
           <div id="hud-boss-phase-progress"><div class="seg telegraph"></div><div class="seg fire"></div></div>
        </div>
        <div class="hud-overdrive-line" id="hud-od-line" aria-live="polite">
          <div class="hud-meter overdrive"><div id="hud-overdrive-bar"></div></div>
          <span id="hud-overdrive-pct">0%</span>
          <span id="hud-overdrive-active">inactive</span>
          <span id="hud-overdrive-remaining">0.00s</span>
        </div>
      </div>
  <div id="hud">
  <div class="hud-panel" id="hud-fairness" aria-live="polite">
          <h2>Fairness</h2>
          <div class="hud-kv"><span>Exposures</span><span data-k="exposures">0</span></div>
          <div class="hud-kv"><span>Min Safe Width</span><span data-k="minWidth">–</span></div>
          <div class="hud-kv"><span>Unsafe Time</span><span data-k="unsafe">0.00s</span></div>
        </div>
  <div class="hud-panel" id="hud-boss" aria-live="polite">
          <h2>Boss</h2>
          <div class="hud-kv"><span>Pattern</span><span data-k="pattern">–</span></div>
          <div class="hud-kv"><span>Telegraph</span><span data-k="telegraph">–</span></div>
          <div class="hud-meter"><div data-k="hpBar"></div></div>
        </div>
  <div class="hud-panel" id="hud-upgrades" aria-live="polite">
          <h2 style="margin-top:0;">Upgrades</h2>
          <div id="hud-upgrades-placeholder" style="font:11px system-ui,sans-serif; opacity:.8;">
            <p style="margin:0 0 4px;">Shop / power-up UI placeholder.</p>
            <ul style="margin:0 0 4px 14px; padding:0; list-style:disc;">
              <li style="margin:0 0 2px;">Wave bonuses</li>
              <li style="margin:0 0 2px;">Turret mods</li>
              <li style="margin:0;">Economy boosts</li>
            </ul>
            <p style="margin:0; font-style:italic;">(Coming soon)</p>
          </div>
        </div>
      </div>
  <div id="hud-bottom">
  <div class="hud-bar health"><div id="hud-health-bar"></div><span class="hud-bar-label" id="hud-health-label">Health 0/0</span></div>
  <div class="hud-bar armor"><div id="hud-armor-bar"></div><span class="hud-bar-label" id="hud-armor-label">Armor 0/0</span></div>
      </div>
  <button id="hud-toggle-btn" type="button" aria-pressed="true"><span class="hud-icon" aria-hidden="true"></span><span class="hud-label">Hide HUD</span></button>
      <button id="settings-btn" type="button" aria-haspopup="true" aria-expanded="false" aria-controls="settings-panel">Settings</button>
      <div id="game-over" role="dialog" aria-modal="true" aria-labelledby="go-title" hidden>
        <h2 id="go-title">Game Over</h2>
        <div class="stats" aria-live="polite">
          <div>Kills: <span data-k="go-kills">0</span></div>
          <div>Wave: <span data-k="go-wave">0</span></div>
          <div>Coins: <span data-k="go-coins">0</span></div>
          <div>Time: <span data-k="go-time">0.00s</span></div>
        </div>
        <div style="display:flex; gap:12px;">
          <button type="button" id="btn-restart">Restart</button>
        </div>
      </div>
      <div id="settings-panel" role="dialog" aria-modal="true" aria-labelledby="settings-title" hidden>
        <div style="background:rgba(0,0,0,.85); padding:20px 24px; border:1px solid rgba(255,255,255,.2); border-radius:12px; width:320px; max-width:90vw; color:#fff; font:13px system-ui,sans-serif;">
          <h2 id="settings-title" style="margin-top:0; font-size:16px;">Settings</h2>
          <div style="display:flex; flex-direction:column; gap:14px;">
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer;"><input type="checkbox" id="opt-motion-reduction" /> <span>Reduce Motion</span></label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer;"><input type="checkbox" id="opt-audio-duck" checked /> <span>Enable Audio Ducking</span></label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer;"><input type="checkbox" id="opt-parallax-disable" /> <span>Disable Parallax (static background)</span></label>
            <label for="opt-master-volume" style="display:flex; flex-direction:column; gap:4px;">
              <span>Master Volume <span id="opt-master-volume-val">1.0</span></span>
              <input id="opt-master-volume" type="range" min="0" max="1" step="0.05" value="1" />
            </label>
            <label for="opt-safe-lane" style="display:flex; flex-direction:column; gap:4px;">
              <span>Safe Lane Highlight Intensity <span id="opt-safe-lane-val">1.0</span></span>
              <input id="opt-safe-lane" type="range" min="0.1" max="1" step="0.1" value="1" />
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
              <input type="checkbox" id="opt-coin-announce" checked /> <span>Announce Coin Changes</span>
            </label>
            <label for="opt-theme-select" style="display:flex; flex-direction:column; gap:4px;">
              <span>Theme
                <select id="opt-theme-select" style="margin-left:8px; max-width:100%;"></select>
              </span>
              <div style="display:flex; align-items:center; gap:8px; margin-top:4px;">
                <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                  <input type="checkbox" id="opt-theme-auto" /> <span>Auto (contrast)</span>
                </label>
                <button type="button" id="opt-theme-audit-run" style="background:#333; color:#fff; border:1px solid #555; padding:4px 8px; border-radius:4px; font:600 11px system-ui,sans-serif; cursor:pointer;">Audit</button>
                <span id="opt-theme-audit-status" style="font:600 11px system-ui,sans-serif;">–</span>
              </div>
              <fieldset style="margin:8px 0 0; padding:6px 8px; border:1px solid rgba(255,255,255,.2); border-radius:6px; display:flex; flex-direction:column; gap:4px;">
                <legend style="font-size:11px; font-weight:600; padding:0 4px;">Auto Mode</legend>
                <label style="display:flex; align-items:center; gap:6px; cursor:pointer; font-size:11px;">
                  <input type="radio" name="theme-auto-mode" value="onChange" id="opt-theme-auto-mode-change" /> On Change
                </label>
                <label style="display:flex; align-items:center; gap:6px; cursor:pointer; font-size:11px;">
                  <input type="radio" name="theme-auto-mode" value="perFrame" id="opt-theme-auto-mode-frame" /> Per Frame (5s throttle)
                </label>
                <label for="opt-theme-auto-interval" style="display:flex; flex-direction:column; gap:4px; font-size:11px; margin-top:4px;">
                  <span>Auto Interval <span id="opt-theme-auto-interval-val">5s</span></span>
                  <input id="opt-theme-auto-interval" type="range" min="1" max="30" step="1" value="5" />
                </label>
              </fieldset>
            </label>
          </div>
          <div style="margin-top:20px; display:flex; justify-content:flex-end; gap:8px;">
            <button type="button" id="settings-close" style="background:#0af; color:#000; border:none; padding:6px 12px; border-radius:6px; font-weight:600; cursor:pointer;">Close</button>
          </div>
        </div>
      </div>
  <!-- Screen reader only live region for concise coin gain/spend announcements -->
  <div id="sr-coin-announce" class="visually-hidden" aria-live="polite" aria-atomic="true"></div>
    </main>
    <script type="module" src="/src/main.ts"></script>
  </body>
</html>
